<html>
    <head>
        <title>The Ebook Hub</title>
        <link rel="stylesheet" href="CSS/shop_stylesheet.css"/>
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
        <meta charset="UTF-8"/>
    </head>
    
    <body>
        <div id="navigation">
            <div id="titel" class="navElemente">
                <a id="title_font" href="Home.html">The Ebook Hub</a>
            </div>

            <div id="selectNav" class="navElemente">              
                    <a href="Home.html">HOME</a>     
                    <a href="Shop.html">SHOP</a>   
                    <a href="AuthorPageÜbersicht.html">AUTOREN</a>          
                    <a href="Warenkorb.html">
                    <img id="warenkorb" src="sources/Warenkorb.png" alt="Warenkorb">
                    </a>                 
            </div>

            <div id="logo"></div>
        </div>   
        
        <div class="shop_body_container" id="shop_container">
			<h1 id="shop_headline">Shop-Übersicht</h1>
		
		
			<div class="Left_container" id="l_container">

				<div id="filter_box">

					<a href="Shop.html"><p>Alle Bücher:</p></a>
				
					
					
					<p class="filter_hover" onclick="show_cat()"><span id="span_cat">&#8722;</span> Kategorien:</p>
					<form id="Filter_container">

						<div id="cat">
					
						
				
				
						</div>
					
					
					

					
						
						<p class="filter_hover" onclick="show_price_slider()"><span id="span_price">&minus;</span> Preis:</p>
						<div id="Price_box">
							
					

							<div class="plus filter_hover"><span onclick="function_plus()">&plus;</span></div>


							<div class="minus filter_hover"><span onclick="function_minus()">&minus;</span></div>


							<div class="slidecontainer">
								<input id="myRange" name="p" type="range" min="1" max="120" value="120" class="slider">
								<p>
								<span id="Space1">0&#8364;</span> <span id="demo"></span><span>&#8364;</span> <span id="Space2">120&#8364;</span>
								</p>
							</div>

						</div>
					


					
					
					<p class="filter_hover" onclick="show_ratings()"><span id="span_rating">&minus;</span> Bewertungen:</p>

					<div class = "Bewertungen" id="Rating_box">
						 
						
						<p><input class="ratingCheckbox" name="r1" type="checkbox" id="1Sterne">
						<span class="fa fa-star checked_star"></span>
						<span class="fa fa-star"></span>
						<span class="fa fa-star"></span>
						<span class="fa fa-star"></span>
						<span class="fa fa-star"></span></p>

						<p></p><input class="ratingCheckbox" name="r2" type="checkbox" id="2Sterne">
						<span class="fa fa-star checked_star"></span>
						<span class="fa fa-star checked_star"></span>
						<span class="fa fa-star"></span>
						<span class="fa fa-star"></span>
						<span class="fa fa-star"></span></p>


						<p></p><input class="ratingCheckbox" name="r3" type="checkbox" id="3Sterne"><span class="fa fa-star checked_star"></span>
						<span class="fa fa-star checked_star"></span>
						<span class="fa fa-star checked_star"></span>
						<span class="fa fa-star"></span>
						<span class="fa fa-star"></span></p>


						<p></p><input class="ratingCheckbox" name="r4" type="checkbox" id="4Sterne"><span class="fa fa-star checked_star"></span>
						<span class="fa fa-star checked_star"></span>
						<span class="fa fa-star checked_star"></span>
						<span class="fa fa-star checked_star"></span>
						<span class="fa fa-star"></span></p>


						<p></p><input class="ratingCheckbox" name="r5" type="checkbox" id="5Sterne"><span class="fa fa-star checked_star"></span>
						<span class="fa fa-star checked_star"></span>
						<span class="fa fa-star checked_star"></span>
						<span class="fa fa-star checked_star"></span>
						<span class="fa fa-star checked_star"></span></p>

					</div>
						<a href="Shop.html"><input style="margin-left:10%; margin-right: 14%;" type="button" value="reset"></input></a>
						<input type="submit" value="submit"></input>

					</form>



					
				</div>

				
			
			</div>
			
			<form class="searchbar_container">
				<input type="text" placeholder="Nach Titel, Autor oder ISBN suchen..." id="suche" name="search">
				<button type="submit" >	<i class="fa fa-search"> </i>	</button>
			</form>
			

			
		</div>
		
		<script src="JS/shop.js"></script>

		<div class="Footer_div">
        <div id="footer">
            <div id="selectFooter" class="FooterElemente">              
                <a href="Impressum.html">Impressum und Kontakt</a>     
                <a href="Datenschutzerklärung.html">Datenschutz</a>   
                <a href="Widerrufsrecht.html">Widerrufsrecht</a>     
            </div>
            <div id="copyright"></div>
        </div>
		</div>



		<script>
			var ajaxBooks;
			var ajaxKategorien;
			var ajaxBookpics=[];
			var ajaxAuthors=[];
			var ajaxGenres=[];
			

			
			function createStars(num){
				var ratingString = "<div class=\"rating_container\">";
				num = Math.round(num);
				for(j=0;j<5;j++){
					if(j<num){
						ratingString += "<span class=\"fa fa-star checked_star\"></span>";
					}
					else{
						ratingString+= "<span class=\"fa fa-star\"></span>";
					}
				}
				ratingString+="</div>";
				return ratingString;
			}

			
			function loadKategorien(){
				$.ajax({
					url: 'http://localhost:8000/web2/buchgenre/gib/all',
					method: 'get',
					dataType: 'json'
            	}).done(function (response) {

					createHtmlKategorien(response.daten);

            	}).fail(function (jqXHR, statusText, error) {
					console.log('Response Code: ' + jqXHR.status + ' - Fehlermeldung: ' + jqXHR.responseText);
					$('#output').html('Ein Fehler ist aufgetreten');
            	});
			}

			
			
			function createHtmlKategorien(value){
				for(var i=0; i<value.length;i++){
					tmp="";
					identifier=""
					if(value[i].id.length==2){identifier=value[i].id;}else{identifier="0"+value[i].id}
					tmp += "<div class=\"elements\"><input class=\"catCheckbox\" name=\"c" + identifier + "\" ";
					tmp += "type=\"checkbox\" id=" + identifier + " color=\"orange\">"
					tmp += "<label for=" + identifier + ">" + value[i].bezeichnung + "</label>" + "</div>"
					$("#cat").append(tmp)
				}
				
				// Man kann erst testen wenn der dynamische Code des Filters erzeugt wurde deswegen macht es Sinn das hier zu machen.
				TestCatAndButtonSet();
			}

			

			function ajax_safeAllBooks(value){
				ajaxBooks=value;

				//Finde das teuerste Buch der angezeigten Ergebnisse
				var maxPrice=0;
				if(ajaxBooks.length==0){maxPrice=20}else{for(var i=0;i<ajaxBooks.length;i++){if(ajaxBooks[i].preis>maxPrice){maxPrice=ajaxBooks[i].preis}}}
				//Das Maximal Attribut und die Value entsprechend anpassen im Preissilder.. Checke leider nicht ganz warum das nicht so richtig klappt. Inhalt von Span???
				console.log(maxPrice);

				
				// CALL additional ajax to get required additional data.
				ajax_safePicsToBooks(value);
				ajax_safeAuthorToBooks(value);
				ajax_safeGenreToBooks(value);
			}

			
			function ajax_safeAdditionalData(value, mode){      // mode = 0 --> speicher Bild         mode = 1 --> speicher Autor     mode = 2 --> speicher genre
				switch(mode){
					case 0:
						ajaxBookpics.push(value.daten);
						break;
					case 1:
						ajaxAuthors.push(value.daten);
						break;
					case 2:
						ajaxGenres.push(value.daten);
						break;
				}

				// WIRD BENÖTIGT WEGEN ASYNC.
				if(ajaxBookpics.length == ajaxBooks.length && ajaxAuthors.length == ajaxBooks.length && ajaxGenres.length == ajaxBooks.length){
					//console.log(ajaxGenres);
					ajaxToHTML();
				}
			}
			
			

		

			function ajax_safePicsToBooks(Books_Json){
				for (i = 0; i < Books_Json.length; i++) {
					obj = Books_Json[i];
					$.ajax({
               			url: 'http://localhost:8000/web2/buchbild/gib/' + obj.bildid ,
                		method: 'get',
                		dataType: 'json'
            		}).done(function (response) {

						ajax_safeAdditionalData(response,0);

            		}).fail(function (jqXHR, statusText, error) {
						ajaxBookpics.push("");               //Hier könnte man den Pfad zu einem "default" Arikelbild reingeben.
                		console.log('Response Code: ' + jqXHR.status + ' - Fehlermeldung: ' + jqXHR.responseText);
                		$('#output').html('Ein Fehler ist aufgetreten');
            		});
				}	
			}


	
			function ajax_safeAuthorToBooks(Books_Json){
				for (i = 0; i <Books_Json.length; i++) {
					obj = Books_Json[i];
					$.ajax({
               			url: 'http://localhost:8000/web2/autor/gib/' + obj.authorid ,
                		method: 'get',
                		dataType: 'json'
            		}).done(function (response) {

						ajax_safeAdditionalData(response,1);

            		}).fail(function (jqXHR, statusText, error) {
						ajaxAuthors.push("");                      //  Was tun wenn loadbyid für Bewerungen failed?
                		console.log('Response Code: ' + jqXHR.status + ' - Fehlermeldung: ' + jqXHR.responseText);
                		$('#output').html('Ein Fehler ist aufgetreten');
            		});
				}
			}
			

			

			function ajax_safeGenreToBooks(Books_Json){
				for (i = 0; i <= Books_Json.length-1; i++) {
					obj = Books_Json[i];
					$.ajax({
               			url: 'http://localhost:8000/web2/buchgenre/gib/' + obj.genreid ,
                		method: 'get',
                		dataType: 'json'
            		}).done(function (response) {
						//console.log(response);
						ajax_safeAdditionalData(response,2);

            		}).fail(function (jqXHR, statusText, error) {
						ajaxGenres.push("");                      //  Was tun wenn loadbyid für Genre failed?
                		console.log('Response Code: ' + jqXHR.status + ' - Fehlermeldung: ' + jqXHR.responseText);
                		$('#output').html('Ein Fehler ist aufgetreten');
            		});
				}
			}

			
			
			


			function ajaxToHTML(){

				console.log(ajaxBooks);
				console.log(ajaxAuthors);
				console.log(ajaxBookpics);
				console.log(ajaxGenres);

				for (i = 0; i < ajaxBooks.length; i++) {
					tmp="";

					bookobj = ajaxBooks[i];
					
					bildobj = ajaxBookpics[i];
					authorobj = ajaxAuthors[i];
					genreobj = ajaxGenres[i];
			
					tmp += "<div class=\"artikel_buble\"><a href=\"Artikelseite.html?titelID=";       
					tmp += bookobj.id + "\">";
					tmp += "<img class=\"artikel_img_container\" src=\""
			   		tmp += bildobj.bildpfad;
					tmp += "\"></img>";
					tmp += "<div class=\"artikel_text_container\"> <p> "
					tmp += "<span class=\"Price_attribute\">"  +  bookobj.preis +   "&euro;</span> <br><br>";
					tmp += "<span class=\"Author_attribute_tag\">Titel:</span><br>";
					tmp += "<span class=\"Author_attribute\">" + bookobj.titel +  ":</span> <br><br> ";
					tmp += "<span class=\" Author_attribute_tag \">Author:</span><br>" + authorobj.name + "<br></span> <br>";
					tmp += "<span class=\"Author_attribute_tag\">Genre:</span><br>  <span class=\"Author_attribute\"> "+ genreobj.bezeichnung + "</span><br><br>";
					tmp += "<span class=\"Author_attribute_tag\">Bewertung:</span> (" + bookobj.anzahlbew +  ") <span>" + createStars(bookobj.gesamtbewertung) + "</span> ";
					// hier muss mit einer if abfrage wenn die Anzahl der Sterne geladen wurde dann entsprehend <span class="fa fa-star"></span> eingefügt werden.
					tmp += "</p></div></a></div>";
					$("#shop_container").append(tmp);
				}
			}

			




			// Hier vielelicht Parameter abfragen ob Filter gesetzt? Dann muss eigentlich nur url ändern?!
			$(document).ready(function() {
				loadKategorien();
				
				//
				
				//

				
				
				
				/*var suche = getUrlParameterByName("search");
				var preis = getUrlParameterByName("price");
				var rat1 = getUrlParameterByName("rating_1s");
				var rat2 = getUrlParameterByName("rating_2s");
				var rat3 = getUrlParameterByName("rating_3s");
				var rat4 = getUrlParameterByName("rating_4s");
				var rat5 = getUrlParameterByName("rating_5s");


				if (suche!=null) {
					
					
					//console.log(suche);
					$.ajax({
						url: 'http://localhost:8000/web2/shop/gib/suche/'+suche,
						method: 'get',
						dataType: 'json'
            		}).done(function (response) {
					
					ajax_safeAllBooks(response.daten);

            		}).fail(function (jqXHR, statusText, error) {
						console.log('Response Code: ' + jqXHR.status + ' - Fehlermeldung: ' + jqXHR.responseText);
						$('#output').html('Ein Fehler ist aufgetreten');
            		});

				}


				else if (preis!=null) {



					//console.log(preis);
					
					
					$.ajax({
						url: 'http://localhost:8000/web2/shop/gib/preis/'+ preis,
						method: 'get',
						dataType: 'json'
					}).done(function (response) {
					
						ajax_safeAllBooks(response.daten);
					

					}).fail(function (jqXHR, statusText, error) {
						console.log('Response Code: ' + jqXHR.status + ' - Fehlermeldung: ' + jqXHR.responseText);
						$('#output').html('Ein Fehler ist aufgetreten');
					});
				}



				else if ((rat1!=null) || (rat2!=null) || (rat3!=null) || (rat4!=null) || (rat5!=null)) {


					if (rat1!=null){

						//console.log(rat1);
						


						$.ajax({
							url: 'http://localhost:8000/web2/shop/gib/rating/'+ 1,
							method: 'get',
							dataType: 'json'
						}).done(function (response) {

							ajax_safeAllBooks(response.daten);

						}).fail(function (jqXHR, statusText, error) {
							console.log('Response Code: ' + jqXHR.status + ' - Fehlermeldung: ' + jqXHR.responseText);
							$('#output').html('Ein Fehler ist aufgetreten');
						});


					}


					else if (rat2!=null){

						//console.log(rat2);



						$.ajax({
							url: 'http://localhost:8000/web2/shop/gib/rating/'+ 2,
							method: 'get',
							dataType: 'json'
						}).done(function (response) {

							ajax_safeAllBooks(response.daten);

						}).fail(function (jqXHR, statusText, error) {
							console.log('Response Code: ' + jqXHR.status + ' - Fehlermeldung: ' + jqXHR.responseText);
							$('#output').html('Ein Fehler ist aufgetreten');
						});


					}

						
				
				}



				else{

					//console.log("Alle anzeigen");
					
					$.ajax({
						url: 'http://localhost:8000/web2/shop/gib/all',
						method: 'get',
						dataType: 'json'
            		}).done(function (response) {
					
					ajax_safeAllBooks(response.daten);

            		}).fail(function (jqXHR, statusText, error) {
						console.log('Response Code: ' + jqXHR.status + ' - Fehlermeldung: ' + jqXHR.responseText);
						$('#output').html('Ein Fehler ist aufgetreten');
            		});

				}*/

        	});



		


			function TestCatAndButtonSet(){
				var catBoxes = document.getElementsByClassName("catCheckbox");
				var control_cat = 0;
				var Kategorien=[];
				var Ratings=[];
				for(var i=0; i<catBoxes.length; i++){
					if (getUrlParameterByName(catBoxes[i].name) == "on"){
						Kategorien.push(catBoxes[i].name)
						catBoxes[i].checked=true;
						control_cat=1;
					}
				}

				var ratBoxes = document.getElementsByClassName("ratingCheckbox")
				var control_rat=0;
				for(var i=0; i<ratBoxes.length;i++){
					if (getUrlParameterByName(ratBoxes[i].name) == "on"){
						Ratings.push(ratBoxes[i].name)   // Man kann auch Ratings.push(ratBox[i].id ## die id == Rating Id auf der DB --> kein parsing mehr!)
						ratBoxes[i].checked=true;				// gleiches gilt für die Kategorien.. !
						control_rat=1
					}
				}
				if(control_rat==1){
					show_ratings();
				}
		
				
			
				// Preis muss nicht abgefragt werden, da der eh immer mit drin ist. WEnn User nix ändert dann ist preis einfach gleich maximal fertig.
				//Der Preis (max Value) muss dynamisch erzeugt werden.

				var preis = getUrlParameterByName("p");

				if(control_cat==1 && control_rat==1){
					console.log("Kategorie und Rating");
					var str="";
					var str1 = "";
					for (var i=0; i<Kategorien.length; i++){
						
						

						str += Kategorien[i];
						console.log(str);

						

						





					}
					
					for(var i = 0; i<Ratings.length; i++){



						str1 += Ratings[i];
					}
					
					
					$.ajax({
							url: 'http://localhost:8000/web2/shop/gib/katrat/'+ str + 'x' + str1 + 'x' + preis,
							method: 'get',
							dataType: 'json'
						}).done(function (response) {

							ajax_safeAllBooks(response.daten);

						}).fail(function (jqXHR, statusText, error) {
							console.log('Response Code: ' + jqXHR.status + ' - Fehlermeldung: ' + jqXHR.responseText);
							$('#output').html('Ein Fehler ist aufgetreten');
						});

					console.log(Kategorien);
					console.log(Ratings);
				}

				else if(getUrlParameterByName("search") != null ){
					console.log("Suche");
					document.getElementById("suche").value=getUrlParameterByName("search");
					var suche = getUrlParameterByName("search");

					
					$.ajax({
						url: 'http://localhost:8000/web2/shop/gib/suche/'+suche,
						method: 'get',
						dataType: 'json'
            		}).done(function (response) {
					
					ajax_safeAllBooks(response.daten);

            		}).fail(function (jqXHR, statusText, error) {
						console.log('Response Code: ' + jqXHR.status + ' - Fehlermeldung: ' + jqXHR.responseText);
						$('#output').html('Ein Fehler ist aufgetreten');
            		});




				}

				else if(control_rat == 0 && control_cat==0){
					
					console.log("Kein Filter")
					$.ajax({
						url: 'http://localhost:8000/web2/shop/gib/all',
						method: 'get',
						dataType: 'json'
            		}).done(function (response) {
					
					ajax_safeAllBooks(response.daten);

            		}).fail(function (jqXHR, statusText, error) {
						console.log('Response Code: ' + jqXHR.status + ' - Fehlermeldung: ' + jqXHR.responseText);
						$('#output').html('Ein Fehler ist aufgetreten');
            		});
				}

				
				
				
				else if(control_cat == 1){
					console.log("Nur Kategorie");
					console.log(Kategorien);

					for(var i = 0; i<Kategorien.length; i++){



						str += Kategorien[i];
					}


					$.ajax({
						url: 'http://localhost:8000/web2/shop/gib/kat/'+ str + 'x' + preis,
						method: 'get',
						dataType: 'json'
					}).done(function (response) {

						ajax_safeAllBooks(response.daten);

					}).fail(function (jqXHR, statusText, error) {
						console.log('Response Code: ' + jqXHR.status + ' - Fehlermeldung: ' + jqXHR.responseText);
						$('#output').html('Ein Fehler ist aufgetreten');
					});




					
				}

				else if(control_rat == 1){
					console.log("Nur Rating");
					console.log(Ratings);


					for(var i = 0; i<Ratings.length; i++){



						str1 += Ratings[i];
					}


					$.ajax({
						url: 'http://localhost:8000/web2/shop/gib/rat/'+ str1 + 'x' + preis,
						method: 'get',
						dataType: 'json'
					}).done(function (response) {

						ajax_safeAllBooks(response.daten);

					}).fail(function (jqXHR, statusText, error) {
						console.log('Response Code: ' + jqXHR.status + ' - Fehlermeldung: ' + jqXHR.responseText);
						$('#output').html('Ein Fehler ist aufgetreten');
					});
				}


			}

			
			
			


			
			
			
			


	



			

			
			function getUrlParameterByName(name,url)
			{
				if (!url) url = window.location.href;
					name = name.replace(/[\[\]]/g, "\\$&");
					var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"), results = regex.exec(url);
				if (!results) return null;
				if (!results[2]) return '';
				return decodeURIComponent(results[2].replace(/\+/g, " "));
			}
		
		</script>

    </body>
</html>